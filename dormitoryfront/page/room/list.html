<div class="layuimini-container layuimini-page-anim">

    <div class="layui-row layui-col-space10">
        <div class="layui-col-md9">
            <!-- 1. æ¥¼æ ‹ -->
            <div class="layuimini-main">
                <div style="height:270px; margin: 30px" id="silk-building" >
                </div>
            </div>
        </div>

        <div class="layui-col-md3">
            <div class="layuimini-main">
                <div id="buildingStatusEcharts" style="height:330px;"></div>
            </div>
        </div>
    </div>

    <div class="layui-row layui-col-space10">
        <div class="layui-col-md3">
            <!-- 2. æ¥¼å±‚ -->
            <div class="layuimini-main">
                <ul class="silk-floor">
                </ul>
            </div>
        </div>
        <div class="layui-col-md9">
            <!-- 3. æˆ¿é—´ -->
            <div class="layuimini-main" style="min-height: 500px">
                <ul class="silk-room">
                    <li>
                        <p style="border-radius: 15px;">å®¿èˆ1</p>
                        <!-- 4. åºŠ ğŸ› -->
                        <ul class="silk-bed">
                            <li style="border-radius: 15px;">yi</li>
                            <li style="border-radius: 15px;">er</li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>


<script>
    layui.use(['form', 'table','miniPage','miniAdmin','element', 'axios', 'echarts'], function () {
        var $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            miniAdmin = layui.miniAdmin,
            axios = layui.axios,
            echarts = layui.echarts,
            miniPage = layui.miniPage;


        var buildingIdForRoom;

        /**
         * @silkTag 1. è·å–æ¥¼æ ‹ä¿¡æ¯
         */
        function loadBuilding(){
            axios.post('building/query', {}).then(function (response) {
                console.log(response.data);
                // éå†åç«¯è¿”å›æ•°æ®ï¼Œå°†æ¥¼æ ‹ä¿¡æ¯è£…åˆ°æ¯ä¸€ä¸ªButtonä¸­
                response.data.forEach(item=>{
                    let dynamicContentButton =
                        '<button class="layui-btn layui-btn-primary layui-btn-radius silk-building" key='+item.id+'>' +
                        '<i class="layui-icon layui-icon-home"></i>' +
                        item.id + 'æ ‹ <small>'+ item.buildingName +
                        '</small></button>\n';                                  // åŠ¨æ€æŒ‰é’®å†…å®¹ï¼ˆKeyä¸­ä¸ºè‡ªå®šä¹‰å±æ€§ï¼‰

                    let dynamicContentButtonObj = $(dynamicContentButton);      // è½¬æˆå¯¹è±¡

                    // ç‚¹å‡»æŒ‰é’®åèƒ½è·å–åˆ°é€‰ä¸­çš„æ¥¼æ ‹id
                    dynamicContentButtonObj.click(function () {
                        $(this).siblings().addClass('layui-btn-primary');       // ç‚¹å‡»æŒ‰é’®åæ”¹å˜é¢œè‰²
                        $(this).removeClass('layui-btn-primary');               // ç‚¹å‡»æŒ‰é’®åæ”¹å˜é¢œè‰²
                        loadFloor($(this).attr("key"));                         // åŠ è½½å½“å‰æ¥¼æ ‹å±‚æ•°
                        buildingIdForRoom = $(this).attr("key");
                    });

                    $('#silk-building').append(dynamicContentButtonObj);
                })
                $('#silk-building button:last').trigger('click');              // é¡µé¢åŠ è½½åï¼Œé»˜è®¤é€‰ä¸­æœ€åä¸€æ ‹æ¥¼ï¼ˆæœ€åä¸€ä¸ªæŒ‰é’®ï¼‰
            }).catch(function (error) {
                layer.msg(error);
            });
        }

        loadBuilding();




        var chartDom = document.getElementById('buildingStatusEcharts');
        var myChart = echarts.init(chartDom);
        var option;

        option = {
            tooltip: {
                formatter: '{a} <br/>{b} : {c}%'
            },
            series: [{
                name: 'æ¥¼æ ‹å…¥ä½ç‡',
                type: 'gauge',
                progress: {
                    show: true
                },
                detail: {
                    valueAnimation: true,
                    formatter: '{value}'
                },
                data: []
            }]
        };

        myChart.setOption(option);

        // echarts çª—å£ç¼©æ”¾è‡ªé€‚åº”
        window.onresize = function () {
            myChart.resize();
        }


        /**
         * @silkTag 2. åŠ è½½æ¥¼å±‚
         */
        function loadFloor(buildingId) {
            // è·å–è¯¥æ¥¼æ ‹çš„å…¥ä½ç‡ä¸å­¦ç”Ÿæ€§åˆ«
            axios.get('building/occupancy_rate_and_gender?buildingId=' + buildingId).then(function (response) {
                console.log(buildingId, 'æ ‹å…¥ä½ç‡ï¼š',response.data[0]);
                let liverGender = response.data[1];
                let echartsColor = '';
                if (liverGender === 0){
                    echartsColor = "#FFB6C1";
                } else {
                    echartsColor = "#87CEFA";
                }

                myChart.setOption({
                    series:[{
                        data: [
                            {
                                value: response.data[0],
                                name: 'å…¥ä½ç‡',
                                itemStyle:{color: echartsColor}
                            }
                        ]
                    }]
                });
            }).catch(function (error) {
                layer.msg(error);
            })



            // è·å–æ¥¼å±‚æ•°é‡
            axios.get('building/query_floor_num?id=' + buildingId).then(function (response) {

                // jQueryç§»é™¤å­èŠ‚ç‚¹(ç§»é™¤ä¹‹å‰é€‰ä¸­æ¥¼æ ‹çš„æ¥¼å±‚åˆ—è¡¨)
                $('.silk-floor').empty();
                for(let floor = 1; floor <= response.data.floorNum; floor++){
                    // åŠ¨æ€æŒ‰é’®å†…å®¹ï¼ˆKeyä¸­ä¸ºè‡ªå®šä¹‰å±æ€§ï¼‰
                    let dynamicContentButton = `
                        <li style="border-radius: 15px;" key='${floor}'>
                            ${floor}æ¥¼
                            <span>
                                <button class="layui-icon layui-icon-add-circle" title="æ·»åŠ æˆ¿é—´"></button>
                            </span>
                        </li>
                    `;

                    // è½¬æˆå¯¹è±¡
                    let dynamicContentButtonObj = $(dynamicContentButton);

                    // ç‚¹å‡»æŒ‰é’®åèƒ½è·å–åˆ°é€‰ä¸­çš„æ¥¼æ ‹id
                    dynamicContentButtonObj.click(function () {
                        $(this).siblings().removeClass('silk-floor-bg');
                        $(this).addClass('silk-floor-bg');
                        loadRoom($(this).attr("key"), buildingIdForRoom);                          // åŠ è½½æˆ¿é—´ä¿¡æ¯
                    });

                    // ç‚¹å‡»æ·»åŠ æŒ‰é’®åæ‰§è¡Œæ·»åŠ æˆ¿é—´çš„åŠŸèƒ½
                    dynamicContentButtonObj.find('button').click(function (event) {
                        // é˜»æ­¢å†’æ³¡(ç‚¹å‡»æ·»åŠ æŒ‰é’®ä¸ä¼šè§¦å‘åˆ·æ–°ä¸€å±‚æ¥¼çš„åŠŸèƒ½)
                        event.stopPropagation();

                        // æ·»åŠ äº‹ä»¶
                        let content = miniPage.getHrefContent('room/addRoom.html');
                        let index = layer.open({
                            title: 'æ·»åŠ æˆ¿é—´',
                            type: 1,
                            shade: 0.3,
                            maxmin:true,                    // æ˜¾ç¤ºæœ€å¤§æœ€å°åŒ–çš„æŒ‰é’®
                            shadeClose: true,
                            area: ['600px', '600px'],       // åŸå§‹å€¼ area: [openWH[0] + 'px', openWH[1] + 'px'],
                            offset: 'auto',                 // åŸå§‹å€¼ offset: [openWH[2] + 'px', openWH[3] + 'px'],
                            content: content,

                            end: function () {
                                dynamicContentButtonObj.trigger('click');     // æ·»åŠ ç»“æŸåè§¦å‘buttonï¼Œä½¿å¾—æˆ¿é—´åˆ—è¡¨é‡æ–°åŠ è½½
                            }
                        });

                        // ä¸ºè¡¨å•èµ‹å€¼
                        form.val('addRoomForm',{
                            buildingId: buildingId,
                            floor: dynamicContentButtonObj.attr("key"),
                        })

                        $(window).on("resize", function () {
                            layer.full(index);
                        });
                    });
                    $('.silk-floor').append(dynamicContentButtonObj);
                }
                $('.silk-floor li:first').trigger('click');                     // é¡µé¢åŠ è½½åï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€å±‚æ¥¼
            }).catch(function (error) {
                layer.msg(error);
            });
        }


        /**
         * @silkTag 3. åŠ è½½æˆ¿é—´åˆ—è¡¨
         */
        function loadRoom(floorId, buildingIdForRoom) {
            axios.post('room/query',{"floor": floorId, "buildingId": buildingIdForRoom}).then(function (response) {
                $('.silk-room').empty();

                response.data.forEach(item=>{
                    console.log(item.brand);

                    let type
                    if (item.roomType === 0){
                        type = ' ';
                    } else if(item.roomType === 1){
                        type = '&nbsp&nbsp<a><span class="layui-badge layui-bg-silk-yellowgreen">å®¿ç®¡</span></a>';
                    } else if(item.roomType === 2){
                        type = '&nbsp&nbsp<a><span class="layui-badge layui-bg-silk-gold">åå‹¤ä¸­å¿ƒ</span></a>';
                    } else if(item.roomType === 3){
                        type = '&nbsp&nbsp<a><span class="layui-badge layui-bg-silk-skyblue">æ‹›å¾…æ‰€</span></a>';
                    } else if(item.roomType === 4){
                        type = '&nbsp&nbsp<a><span class="layui-badge layui-bg-silk-coral">å°å–éƒ¨</span></a>';
                    } else if(item.roomType === 5){
                        type = '&nbsp&nbsp<a><span class="layui-badge layui-bg-silk-super-light-gray">æ‚ç‰©é—´</span></a>';
                    }

                    let capacity
                    if (item.roomCapacity === 0){
                        capacity = '&nbsp&nbsp<a><span class="layui-badge layui-bg-silk-super-light-gray">ä¸ä½äºº</span></a> ';
                    }else {
                        capacity = '';
                    }


                    let html = `
                        <li>
                            <p key='${item.id}'>
                                ${item.brand}${type}${capacity}
                                <span>
                                    <button class="layui-icon layui-icon-add-circle silk-bed-add" title="æ·»åŠ åºŠä½"></button>
                                    <button class="layui-icon layui-icon-delete silk-room-delete" title="åˆ é™¤æˆ¿é—´"></button>
                                </span>
                            </p>
                            <ul class="silk-bed">
                                <li></li>
                                <li></li>
                                <li></li>
                                <li></li>
                                <li></li>
                            </ul>
                        </li>
                    `;                                  // åŠ¨æ€æŒ‰é’®å†…å®¹ï¼ˆKeyä¸­ä¸ºè‡ªå®šä¹‰å±æ€§ï¼‰

                    let htmlObj = $(html);      // è½¬æˆå¯¹è±¡

                    // ç‚¹å‡»æˆ¿é—´åè¿›è¡ŒæŠ˜å ä¸å±•ç¤º
                    htmlObj.find('p').click(function () {
                        $(this).siblings().toggle(300);
                        loadBed($(this).attr("key"), $(this).siblings());
                    });

                    // ç‚¹å‡»åæ·»åŠ åºŠä½
                    htmlObj.find('.silk-bed-add').click(function (event) {
                        event.stopPropagation();
                        let roomId =  htmlObj.find('p').attr("key");        // è·å–roomçš„ID
                        axios.get('room/capacity_plus_one?id='+ roomId).then(function (response) {
                            layer.msg(response.msg);
                            loadBed(htmlObj.find('p').attr("key"), htmlObj.find('p').siblings());   // é‡æ–°åŠ è½½æˆ¿é—´ä¸­çš„åºŠ
                        }).catch(function (error) {
                            layer.msg(error);
                        });
                    });

                    // ç‚¹å‡»ååˆ é™¤è¯¥æˆ¿é—´
                    htmlObj.find('.silk-room-delete').click(function (event) {
                        event.stopPropagation();
                        layer.confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ", function (index) {
                            let roomIds =  htmlObj.find('p').attr("key");        // è·å–roomçš„ID
                            axios.get('room/delete?ids=' + roomIds).then(function (response) {
                                layer.msg(response.msg);
                                htmlObj.remove();               // å‰ç«¯ç§»é™¤è¯¥å¯¹è±¡
                                layer.close(index);
                            }).catch(function (error) {
                                layer.msg(error);
                            });
                        })
                    });
                    $('.silk-room').append(htmlObj);
                });
                console.log(response.data);
            }).catch(function (error) {
                layer.msg(error);
            });
        }


        /**
         * @silkTag 4. åŠ è½½åºŠä½
         */
        function loadBed(roomId, bedObj) {
            console.log(roomId, bedObj);


            var liverAmount;

            axios.get('room/query_liver_amount?id=' + roomId).then(function (response) {
                liverAmount = response.data;

                axios.post('room/query',{"id": roomId}).then(function (response) {
                    bedObj.empty();
                    console.log(response.data[0].roomCapacity);

                    for (let bedNo = 1; bedNo <= response.data[0].roomCapacity; bedNo++){
                        let html;

                        if (bedNo <= liverAmount){
                            html=`
                        <li>

                            <img class="silk-bed-image" src="../images/bed_active.png"/>
                            <p style="margin-top: 15px;">åºŠä½${bedNo}</p>
                            <!--<p style="margin-top: 20px;">
                                <i class="layui-icon layui-icon-edit" title="ç¼–è¾‘åºŠä½"></i>
                            </p>-->
                        </li>
                    `;

                            let htmlObj = $(html);

                            // ç‚¹å‡»åˆ é™¤åºŠä½
                            htmlObj.find('.silk-bed-delete').click(function (event) {
                                event.stopPropagation();

                                layer.confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ", function (index) {
                                    axios.get('room/capacity_minus_one?id='+ roomId).then(function (response) {
                                        htmlObj.remove();
                                        layer.msg(response.msg);
                                        layer.close(index);
                                        loadBed(roomId, bedObj);   // é‡æ–°åŠ è½½æˆ¿é—´ä¸­çš„åºŠ
                                    }).catch(function (error) {
                                        layer.msg(error);
                                    });
                                })

                            });
                            bedObj.append(htmlObj);
                        } else {
                            html=`
                        <li>

                            <img class="silk-bed-image" src="../images/bed.png"/>
                            <p style="margin-top: 15px;">åºŠä½${bedNo}</p>
                            <p style="margin-top: 0px;">
                                <i class="layui-icon layui-icon-delete silk-bed-delete" title="åˆ é™¤åºŠä½"></i>
                                <!--<i class="layui-icon layui-icon-edit" title="ç¼–è¾‘åºŠä½"></i>-->
                            </p>
                        </li>
                    `;

                            let htmlObj = $(html);

                            // ç‚¹å‡»åˆ é™¤åºŠä½
                            htmlObj.find('.silk-bed-delete').click(function (event) {
                                event.stopPropagation();

                                layer.confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ", function (index) {
                                    axios.get('room/capacity_minus_one?id='+ roomId).then(function (response) {
                                        htmlObj.remove();
                                        layer.msg(response.msg);
                                        layer.close(index);
                                        loadBed(roomId, bedObj);   // é‡æ–°åŠ è½½æˆ¿é—´ä¸­çš„åºŠ
                                    }).catch(function (error) {
                                        layer.msg(error);
                                    });
                                })
                            });
                            bedObj.append(htmlObj);
                        }
                    }
                }).catch(function (error) {
                    layer.msg(error);
                });
            }).catch(function (error) {
                layer.msg(error);
            });
        }
    });
</script>